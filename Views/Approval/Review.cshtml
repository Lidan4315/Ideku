@model Ideku.ViewModels.Approval.ApprovalReviewViewModel

@{
    ViewData["Title"] = "Idea Review";
}

@section Styles {
    <link rel="stylesheet" href="~/css/shared/approval-history-timeline.css" asp-append-version="true" />
    <link rel="stylesheet" href="~/css/pages/approval-review.css" asp-append-version="true" />
}

<div class="container-fluid">
    <!-- Page Header -->
    <div class="page-header-modern mb-4">
        <h1 class="page-title text-gradient mb-3">
            Review Idea
        </h1>

        <!-- Breadcrumb Navigation -->
        <nav aria-label="breadcrumb">
            <ol class="breadcrumb mb-0">
                <li class="breadcrumb-item">
                    <a href="@Url.Action("Index", "Approval")">Need Approval</a>
                </li>
                <li class="breadcrumb-item">Review</li>
                <li class="breadcrumb-item active" aria-current="page">@Model.Idea.IdeaCode</li>
            </ol>
        </nav>
    </div>

    <!-- Idea Details Section -->
    @await Html.PartialAsync("_IdeaDetails", Model.Idea)

    <!-- Attachments Section -->
    <div class="card shadow mb-4">
        <div class="card-header py-3">
            <h5 class="m-0 font-weight-bold text-gradient">
                <i class="bi bi-paperclip me-2"></i>Attachments
            </h5>
        </div>
        <div class="card-body">
            @await Html.PartialAsync("_IdeaAttachments", Model.Idea)
        </div>
    </div>

    <!-- Validation Decision Section -->
    @if (ViewBag.CanTakeAction == true)
    {
        <div class="card shadow mb-4">
            <div class="card-header py-3">
                <h5 class="m-0 font-weight-bold text-gradient">Validation Decision</h5>
            </div>
            <div class="card-body">
                <form asp-action="Approve" asp-route-id="@Model.Idea.Id" method="post" enctype="multipart/form-data">
                    @Html.AntiForgeryToken()
                    <div class="approve-section mb-4">
                        <h5><i class="fas fa-check-circle text-success"></i> Approve Idea</h5>
                        
                        <div class="form-group mb-3">
                            <label asp-for="ValidatedSavingCost" class="form-label">
                                Validated Saving Cost (USD) <span class="text-danger">*</span>
                            </label>
                            
                            <!-- Display field dengan comma formatting -->
                            <input type="text" class="form-control" id="validatedCostDisplay" 
                                   placeholder="Enter validated saving cost" />
                            
                            <!-- Hidden field untuk form submission -->
                            <input type="hidden" asp-for="ValidatedSavingCost" id="validatedCostHidden" />
                                   
                            <small class="form-text text-muted mt-1">
                                <i class="bi bi-check-circle me-1"></i>
                                Enter the validated saving cost amount
                            </small>
                            
                            <span asp-validation-for="ValidatedSavingCost" class="text-danger"></span>
                        </div>
                        <div class="form-group mb-3">
                            <label asp-for="ApprovalComments" class="form-label">
                                Approval Comments <span class="text-danger">*</span>
                            </label>
                            <textarea asp-for="ApprovalComments" class="form-control" rows="3" 
                                      placeholder="Please provide detailed approval comments"></textarea>
                            <span asp-validation-for="ApprovalComments" class="text-danger"></span>
                        </div>

                        <!-- Additional Files Section -->
                        <div class="form-group mb-3">
                            <label class="form-label">
                                <i class="bi bi-paperclip me-1"></i>Attachments File
                                @if (Model.IsFileRequired)
                                {
                                    <span class="text-danger">*</span>
                                    <small class="text-danger">(Required - Initiator did not upload files)</small>
                                }
                                else
                                {
                                    <small class="text-muted">(Optional)</small>
                                }
                            </label>
                            
                            <!-- File Upload Container with Dashed Border -->
                            <div class="file-upload-container">
                                <input type="file" id="approvalFileInput" class="d-none" accept=".pdf,.doc,.docx,.xlsx,.jpg,.jpeg,.png" />

                                <!-- Browse Files Button -->
                                <div class="file-upload-header">
                                    <button type="button" class="btn btn-outline-gray" onclick="document.getElementById('approvalFileInput').click()">
                                        <i class="bi bi-folder2-open me-2"></i><span class="d-none d-md-inline">Browse Files</span><span class="d-inline d-md-none">Browse</span>
                                    </button>
                                    <small class="form-text text-muted ms-2 d-none d-md-inline">Select one or multiple files. Accepted: PDF, DOC, DOCX, XLSX, JPG, PNG (Max 10 MB total)</small>
                                </div>

                                <!-- Mobile File Info (shown below button on mobile) -->
                                <small class="form-text text-muted d-block d-md-none mt-2">
                                    Accepted: PDF, DOC, DOCX, XLSX, JPG, PNG (Max 10 MB total)
                                </small>

                                <!-- Selected Files List -->
                                <div id="approvalFilesList" class="files-list-container">
                                    <div class="text-muted text-center" id="noApprovalFilesMessage">
                                        <i class="bi bi-cloud-arrow-up fs-1 d-block mb-2"></i>
                                        No files added yet
                                    </div>
                                </div>

                                <!-- Hidden inputs for files -->
                                <div id="hiddenApprovalFileInputs"></div>
                            </div>
                            
                            <span asp-validation-for="ApprovalFiles" class="text-danger"></span>
                        </div>

                        <div class="form-group mb-3">
                            <label class="form-label">
                                <i class="bi bi-building me-1"></i>Related Divisions
                                <small class="text-muted">(Optional - Select divisions whose Workstream Leaders should be notified)</small>
                            </label>

                            <!-- Hidden input to store selected division IDs -->
                            <input asp-for="SelectedRelatedDivisions" type="hidden" id="selectedDivisionsInput" />

                            <!-- Button + Tags Interface -->
                            <div class="file-upload-container">
                                <div class="d-flex flex-wrap align-items-center gap-2 mb-2">
                                    <!-- Add Division Button -->
                                    <div class="dropdown position-relative">
                                        <button type="button" class="btn dropdown-toggle btn-outline-gray"
                                                id="addDivisionBtn" data-bs-toggle="dropdown" aria-expanded="false">
                                            <i class="bi bi-building-add me-2"></i>Select Division
                                        </button>
                                        <ul class="dropdown-menu" aria-labelledby="addDivisionBtn" id="divisionsDropdown">
                                            @foreach (var division in Model.AvailableDivisions)
                                            {
                                                <li>
                                                    <a class="dropdown-item division-option" href="#"
                                                       data-division-id="@division.Value"
                                                       data-division-name="@division.Text">
                                                        @division.Text
                                                    </a>
                                                </li>
                                            }
                                        </ul>
                                    </div>

                                    <!-- Selected Divisions Tags -->
                                    <div id="selectedDivisionsTags" class="d-flex flex-wrap gap-2">
                                        <!-- Tags will be dynamically added here -->
                                    </div>
                                </div>

                                <!-- Info message -->
                                <div id="divisionsInfo" class="related-divisions-info d-none">
                                    <small class="text-muted">
                                        <i class="bi bi-info-circle me-1"></i>
                                        <strong><span id="selectedCount">0</span> division(s)</strong> selected. 
                                        Workstream Leaders from selected divisions will receive email notifications.
                                    </small>
                                </div>
                            </div>
                            
                            <span asp-validation-for="SelectedRelatedDivisions" class="text-danger"></span>
                        </div>

                        <button type="submit" class="btn btn-success" id="approveBtn"><i class="fas fa-check"></i> Approve Idea</button>
                    </div>
                </form>
                <hr />
                <form asp-action="SendFeedback" asp-route-id="@Model.Idea.Id" method="post">
                    @Html.AntiForgeryToken()
                    <div class="feedback-section">
                        <h5><i class="fas fa-comment-dots text-info"></i> Feedback Idea</h5>
                        <p class="text-muted small mb-3">
                            <i class="bi bi-info-circle me-1"></i>
                            Provide feedback to the initiator and Workstream Leader without approving or rejecting. The idea will remain at the current stage.
                        </p>
                        <div class="form-group mb-3">
                            <label asp-for="FeedbackComment" class="form-label">
                                Feedback Comment <span class="text-danger">*</span>
                            </label>
                            <textarea asp-for="FeedbackComment" class="form-control" rows="3"
                                      placeholder="Please provide your feedback or questions for the initiator"></textarea>
                            <span asp-validation-for="FeedbackComment" class="text-danger"></span>
                        </div>
                        <button type="submit" class="btn btn-info" id="feedbackBtn"><i class="fas fa-comment"></i> Feedback Idea</button>
                    </div>
                </form>
                <hr />
                <form asp-action="Reject" asp-route-id="@Model.Idea.Id" method="post">
                    @Html.AntiForgeryToken()
                    <div class="reject-section">
                        <h5><i class="fas fa-times-circle text-danger"></i> Reject Idea</h5>
                        <div class="form-group mb-3">
                            <label asp-for="RejectionReason" class="form-label">
                                Rejection Reason <span class="text-danger">*</span>
                            </label>
                            <textarea asp-for="RejectionReason" class="form-control" rows="3" placeholder="Please provide a clear reason for rejection"></textarea>
                            <span asp-validation-for="RejectionReason" class="text-danger"></span>
                        </div>
                        <button type="submit" class="btn btn-danger" id="rejectBtn"><i class="fas fa-times"></i> Reject Idea</button>
                    </div>
                </form>
            </div>
        </div>
    }
    else
    {
        <!-- Approval Timeline -->
        <div class="card shadow mb-4">
            <div class="card-header py-3">
                <h6 class="m-0 font-weight-bold text-primary">
                    <i class="bi bi-clock-history me-2"></i>Approval Timeline
                </h6>
            </div>
            <div class="card-body">
                <!-- Current Stage -->
                <div class="timeline-item mb-4">
                    <div class="row">
                        <div class="col-md-3">
                            <div class="text-center">
                                <div class="timeline-icon bg-primary">
                                    <i class="bi bi-hourglass-split text-white"></i>
                                </div>
                                <small class="text-muted d-block mt-2">
                                    <strong>Stage</strong>
                                </small>
                            </div>
                        </div>
                        <div class="col-md-9">
                            <div class="timeline-content">
                                <h6 class="mb-2">
                                    <span class="badge bg-primary me-2">Stage S@(Model.Idea.CurrentStage)</span>
                                    <strong>In Progress</strong>
                                </h6>
                                <div class="alert alert-info mb-0" role="alert">
                                    <i class="bi bi-eye me-2"></i>
                                    <strong>Read-Only Access:</strong> This idea is no longer in your approval stage.
                                </div>
                            </div>
                        </div>
                    </div>
                </div>

                <!-- Latest History -->
                @if (ViewBag.WorkflowHistory != null)
                {
                    var workflowHistory = ViewBag.WorkflowHistory as IEnumerable<Ideku.Models.Entities.WorkflowHistory>;
                    if (workflowHistory != null && workflowHistory.Any())
                    {
                        // Show only the latest history entry
                        var latestHistory = workflowHistory.Take(1);
                        @await Html.PartialAsync("_ApprovalHistoryTimeline", latestHistory)
                    }
                    else
                    {
                        <div class="text-center text-muted">
                            <i class="bi bi-clock me-2"></i>
                            <em>No approval history available yet.</em>
                        </div>
                    }
                }
            </div>
        </div>
    }
</div>

<!-- Include File Preview Modal -->
@await Html.PartialAsync("_FilePreviewModal")

@section Scripts {
<script src="https://cdn.jsdelivr.net/npm/sweetalert2@11"></script>
<script>
    document.addEventListener('DOMContentLoaded', function() {
        // Initialize Related Divisions Dropdown
        initializeRelatedDivisionsSelect();

        // Initialize Validated Saving Cost Visual Feedback
        initializeValidatedSavingCostFeedback();
        
        // Initialize file upload for approval
        initializeApprovalFileUpload();

        // Handle Approve form
        const approveForm = document.querySelector('form[action*="Approve"]');
        if (approveForm) {
            approveForm.addEventListener('submit', function(e) {
                e.preventDefault();
                
                // Client-side validation - Handle conditional field
                const validatedSavingCostHidden = document.getElementById('validatedCostHidden');
                const validatedSavingCostDisplay = document.getElementById('validatedCostDisplay');
                const approvalComments = document.querySelector('textarea[name="ApprovalComments"]').value;

                // Validate conditional file requirement
                const hasInitiatorFiles = @Html.Raw(Json.Serialize(Model.HasInitiatorFiles));
                const hasApprovalFiles = selectedApprovalFiles.length > 0;
                
                if (!hasInitiatorFiles && !hasApprovalFiles) {
                    Swal.fire({
                        icon: 'warning',
                        title: 'Files Required',
                        text: 'Please upload at least one file since initiator did not upload any files.'
                    });
                    return;
                }
                
                // Validate Validated Saving Cost only if field exists (Stage 1+)
                if (validatedSavingCostHidden && validatedSavingCostDisplay) {
                    const numericValue = validatedSavingCostHidden.value;
                    const displayValue = validatedSavingCostDisplay.value;
                    
                    if (!displayValue.trim()) {
                        Swal.fire({
                            icon: 'warning',
                            title: 'Warning!',
                            text: 'Validated saving cost is required'
                        });
                        return;
                    }
                    
                    if (!numericValue || parseFloat(numericValue) < 0 || isNaN(parseFloat(numericValue))) {
                        Swal.fire({
                            icon: 'warning',
                            title: 'Warning!',
                            text: 'Validated saving cost must be 0 or greater'
                        });
                        return;
                    }
                }
                // For Stage 0: Skip validated saving cost validation
                
                if (!approvalComments.trim()) {
                    Swal.fire({
                        icon: 'warning',
                        title: 'Warning!',
                        text: 'Approval comments are required'
                    });
                    return;
                }
                
                // Get selected related divisions from tags interface
                const selectedInput = document.getElementById('selectedDivisionsInput');
                const selectedDivisionIds = selectedInput.value ? selectedInput.value.split(',') : [];
                const selectedDivisionNames = [];
                
                // Get division names from the tags displayed
                const divisionTags = document.querySelectorAll('.division-tag span');
                divisionTags.forEach(tag => {
                    selectedDivisionNames.push(tag.textContent.trim());
                });
                
                let confirmText = 'Are you sure you want to approve this idea?';
                if (selectedDivisionNames.length > 0) {
                    confirmText = 'Are you sure you want to approve this idea? Workstream Leaders from selected divisions will be notified.';
                }
                
                Swal.fire({
                    title: 'Confirm Approval',
                    text: confirmText,
                    icon: 'question',
                    showCancelButton: true,
                    confirmButtonColor: '#28a745',
                    cancelButtonColor: '#6c757d',
                    confirmButtonText: 'Yes, Approve!',
                    cancelButtonText: 'Cancel'
                }).then((result) => {
                    if (result.isConfirmed) {
                        // Show loading state
                        const approveBtn = document.getElementById('approveBtn');
                        const originalBtnContent = approveBtn.innerHTML;
                        approveBtn.disabled = true;
                        approveBtn.innerHTML = '<span class="spinner-border spinner-border-sm me-2"></span>Processing...';
                        
                        // Submit form by creating a new form submission
                        const formData = new FormData(approveForm);
                        fetch(approveForm.action, {
                            method: 'POST',
                            body: formData
                        }).then(response => {
                            // Reset button state
                            approveBtn.disabled = false;
                            approveBtn.innerHTML = originalBtnContent;
                            
                            if (response.redirected) {
                                Swal.fire({
                                    icon: 'success',
                                    title: 'Success!',
                                    text: 'Idea has been approved successfully!',
                                    timer: 2000,
                                    showConfirmButton: false
                                }).then(() => {
                                    window.location.href = response.url;
                                });
                            }
                        }).catch(error => {
                            // Reset button state on error
                            approveBtn.disabled = false;
                            approveBtn.innerHTML = originalBtnContent;
                            
                            Swal.fire({
                                icon: 'error',
                                title: 'Error!',
                                text: 'An error occurred while processing approval.'
                            });
                        });
                    }
                });
            });
        }
        
        // Handle Reject form
        const rejectForm = document.querySelector('form[action*="Reject"]');
        if (rejectForm) {
            rejectForm.addEventListener('submit', function(e) {
                e.preventDefault();
                
                const rejectionReason = document.querySelector('textarea[name="RejectionReason"]').value;
                if (!rejectionReason.trim()) {
                    Swal.fire({
                        icon: 'warning',
                        title: 'Warning!',
                        text: 'Rejection reason is required'
                    });
                    return;
                }
                
                Swal.fire({
                    title: 'Confirm Rejection',
                    text: 'Are you sure you want to reject this idea?',
                    icon: 'warning',
                    showCancelButton: true,
                    confirmButtonColor: '#dc3545',
                    cancelButtonColor: '#6c757d',
                    confirmButtonText: 'Yes, Reject!',
                    cancelButtonText: 'Cancel'
                }).then((result) => {
                    if (result.isConfirmed) {
                        // Show loading state
                        const rejectBtn = document.getElementById('rejectBtn');
                        const originalBtnContent = rejectBtn.innerHTML;
                        rejectBtn.disabled = true;
                        rejectBtn.innerHTML = '<span class="spinner-border spinner-border-sm me-2"></span>Processing...';
                        
                        // Submit form by creating a new form submission
                        const formData = new FormData(rejectForm);
                        fetch(rejectForm.action, {
                            method: 'POST',
                            body: formData
                        }).then(response => {
                            // Reset button state
                            rejectBtn.disabled = false;
                            rejectBtn.innerHTML = originalBtnContent;
                            
                            if (response.redirected) {
                                Swal.fire({
                                    icon: 'success',
                                    title: 'Success!',
                                    text: 'Idea has been rejected successfully!',
                                    timer: 2000,
                                    showConfirmButton: false
                                }).then(() => {
                                    window.location.href = response.url;
                                });
                            }
                        }).catch(error => {
                            // Reset button state on error
                            rejectBtn.disabled = false;
                            rejectBtn.innerHTML = originalBtnContent;
                            
                            Swal.fire({
                                icon: 'error',
                                title: 'Error!',
                                text: 'An error occurred while processing rejection.'
                            });
                        });
                    }
                });
            });
        }

        // Handle Feedback form
        const feedbackForm = document.querySelector('form[action*="SendFeedback"]');
        if (feedbackForm) {
            feedbackForm.addEventListener('submit', function(e) {
                e.preventDefault();

                const feedbackComment = document.querySelector('textarea[name="FeedbackComment"]').value;
                if (!feedbackComment.trim()) {
                    Swal.fire({
                        icon: 'warning',
                        title: 'Warning!',
                        text: 'Feedback comment is required'
                    });
                    return;
                }

                Swal.fire({
                    title: 'Send Feedback',
                    text: 'Are you sure you want to send this feedback? The initiator and Workstream Leaders will be notified.',
                    icon: 'info',
                    showCancelButton: true,
                    confirmButtonColor: '#17a2b8',
                    cancelButtonColor: '#6c757d',
                    confirmButtonText: 'Yes, Send!',
                    cancelButtonText: 'Cancel'
                }).then((result) => {
                    if (result.isConfirmed) {
                        // Show loading state
                        const feedbackBtn = document.getElementById('feedbackBtn');
                        const originalBtnContent = feedbackBtn.innerHTML;
                        feedbackBtn.disabled = true;
                        feedbackBtn.innerHTML = '<span class="spinner-border spinner-border-sm me-2"></span>Sending...';

                        // Submit form by creating a new form submission
                        const formData = new FormData(feedbackForm);
                        fetch(feedbackForm.action, {
                            method: 'POST',
                            body: formData
                        }).then(response => {
                            // Reset button state
                            feedbackBtn.disabled = false;
                            feedbackBtn.innerHTML = originalBtnContent;

                            if (response.redirected) {
                                Swal.fire({
                                    icon: 'success',
                                    title: 'Success!',
                                    text: 'Feedback has been sent successfully!',
                                    timer: 2000,
                                    showConfirmButton: false
                                }).then(() => {
                                    window.location.href = response.url;
                                });
                            }
                        }).catch(error => {
                            // Reset button state on error
                            feedbackBtn.disabled = false;
                            feedbackBtn.innerHTML = originalBtnContent;

                            Swal.fire({
                                icon: 'error',
                                title: 'Error!',
                                text: 'An error occurred while sending feedback.'
                            });
                        });
                    }
                });
            });
        }
    });

    function escapeHtml(text) {
        const div = document.createElement('div');
        div.textContent = text;
        return div.innerHTML;
    }
    
    // Related Divisions Button + Tags Functions
    function initializeRelatedDivisionsSelect() {
        initializeDivisionsTagsInterface();
    }
    
    function initializeDivisionsTagsInterface() {
        const addBtn = document.getElementById('addDivisionBtn');
        const dropdownItems = document.querySelectorAll('.division-option');
        const selectedInput = document.getElementById('selectedDivisionsInput');
        const tagsContainer = document.getElementById('selectedDivisionsTags');
        const infoPanel = document.getElementById('divisionsInfo');
        
        if (!addBtn || !selectedInput || !tagsContainer) return;
        
        // Store selected divisions
        let selectedDivisions = [];
        
        // Handle dropdown item clicks
        dropdownItems.forEach(item => {
            item.addEventListener('click', function(e) {
                e.preventDefault();
                
                const divisionId = this.dataset.divisionId;
                const divisionName = this.dataset.divisionName;
                
                // Check if already selected
                if (!selectedDivisions.find(d => d.id === divisionId)) {
                    // Add to selected list
                    selectedDivisions.push({ id: divisionId, name: divisionName });
                    
                    // Update UI
                    updateTagsDisplay();
                    updateDropdownOptions();
                    updateHiddenInput();
                    updateInfoPanel();
                    
                    // Close dropdown
                    bootstrap.Dropdown.getInstance(addBtn)?.hide();
                }
            });
        });
        
        function updateTagsDisplay() {
            tagsContainer.innerHTML = '';
            
            selectedDivisions.forEach((division, index) => {
                const tag = document.createElement('div');
                tag.className = 'division-tag';
                tag.innerHTML = `
                    <span>${division.name}</span>
                    <button type="button" class="remove-btn" data-index="${index}" title="Remove ${division.name}">
                        <i class="bi bi-x"></i>
                    </button>
                `;
                
                // Add remove functionality
                const removeBtn = tag.querySelector('.remove-btn');
                removeBtn.addEventListener('click', function() {
                    const indexToRemove = parseInt(this.dataset.index);
                    selectedDivisions.splice(indexToRemove, 1);
                    updateTagsDisplay();
                    updateDropdownOptions();
                    updateHiddenInput();
                    updateInfoPanel();
                });
                
                tagsContainer.appendChild(tag);
            });
        }
        
        function updateDropdownOptions() {
            dropdownItems.forEach(item => {
                const divisionId = item.dataset.divisionId;
                const isSelected = selectedDivisions.find(d => d.id === divisionId);
                
                if (isSelected) {
                    item.classList.add('selected');
                    item.style.display = 'none'; // Hide selected items
                } else {
                    item.classList.remove('selected');
                    item.style.display = 'block';
                }
            });
            
            // Update button text
            const availableCount = Array.from(dropdownItems).filter(item => item.style.display !== 'none').length;
            if (availableCount === 0) {
                addBtn.innerHTML = '<i class="bi bi-check-circle me-2"></i>All Divisions Selected';
                addBtn.classList.add('disabled');
                addBtn.style.opacity = '0.6';
            } else {
                addBtn.innerHTML = '<i class="bi bi-building-add me-2"></i>Select Division';
                addBtn.classList.remove('disabled');
                addBtn.style.opacity = '1';
            }
        }
        
        function updateHiddenInput() {
            const selectedIds = selectedDivisions.map(d => d.id);
            selectedInput.value = selectedIds.join(',');
        }
        
        function updateInfoPanel() {
            const selectedCount = document.getElementById('selectedCount');
            
            if (selectedDivisions.length > 0) {
                infoPanel.classList.remove('d-none');
                selectedCount.textContent = selectedDivisions.length;
            } else {
                infoPanel.classList.add('d-none');
            }
        }
        
        // Initialize display
        updateTagsDisplay();
        updateDropdownOptions();
        updateInfoPanel();
    }
    
    // Validated Saving Cost Formatting - Only for Stage 1+
    function initializeValidatedSavingCostFeedback() {
        const displayInput = document.getElementById('validatedCostDisplay');
        const hiddenInput = document.getElementById('validatedCostHidden');
        
        // Check if fields exist (only for Stage 1+)
        if (!displayInput || !hiddenInput) {
            return; // Fields not present for Stage 0
        }
        
        // Initialize field based on stage
        const currentStage = @Model.Idea.CurrentStage;
        const originalValue = hiddenInput.value;
        
        if (currentStage > 0 && originalValue && originalValue !== '') {
            // Stage 1+: Auto-fill from previous approver
            displayInput.value = formatNumberWithCommas(originalValue);
            hiddenInput.value = originalValue;
        } else {
            // Stage 0: Start empty, approver fills manually
            displayInput.value = '';
            hiddenInput.value = '';
        }
        
        // Real-time formatting dan sync
        displayInput.addEventListener('input', function() {
            var value = this.value;
            
            // Remove all non-digit characters (integers only)
            var numericValue = value.replace(/[^\d]/g, '');
            
            // Format display field dengan thousand separator
            if (numericValue) {
                var formattedValue = formatNumberWithCommas(numericValue);
                this.value = formattedValue;
                
                // Store raw numeric value in hidden field
                hiddenInput.value = numericValue;
            } else {
                hiddenInput.value = '';
            }
        });
    }
    
    // Currency formatting function (integers only)
    function formatNumberWithCommas(value) {
        // Add commas to integer part
        return value.replace(/\B(?=(\d{3})+(?!\d))/g, ',');
    }

    // Global variables for approval file upload
    let selectedApprovalFiles = [];
    let approvalFileCounter = 0;

    // Approval File Upload Functions
    function initializeApprovalFileUpload() {
        const fileInput = document.getElementById('approvalFileInput');
        if (!fileInput) return;

        fileInput.addEventListener('change', function() {
            const file = this.files[0];
            if (!file) return;
            
            // Check file size (max 10MB)
            if (file.size > 10 * 1024 * 1024) {
                Swal.fire({
                    icon: 'warning',
                    title: 'File Too Large',
                    text: 'File size must be less than 10MB',
                    confirmButtonText: 'OK'
                });
                return;
            }
            
            // Add file to array
            const fileObj = {
                id: approvalFileCounter++,
                file: file,
                name: file.name,
                size: file.size,
                type: file.type
            };
            
            selectedApprovalFiles.push(fileObj);
            addApprovalFileToList(fileObj);
            createHiddenApprovalInput(fileObj);
            updateApprovalFilesDisplay();
            
            // Reset input
            this.value = '';
        });
    }

    function addApprovalFileToList(fileObj) {
        const fileSize = formatFileSize(fileObj.size);
        const fileIcon = getFileIcon(fileObj.name);
        
        const fileItem = `
            <div class="d-flex align-items-center justify-content-between p-2 border rounded mb-2 bg-white" id="approvalFile-${fileObj.id}">
                <div class="d-flex align-items-center">
                    <i class="bi ${fileIcon} fs-4 me-3 text-primary"></i>
                    <div>
                        <div class="fw-medium">${fileObj.name}</div>
                        <small class="text-muted">${fileSize}</small>
                    </div>
                </div>
                <button type="button" class="btn btn-outline-danger btn-sm" onclick="removeApprovalFile(${fileObj.id})">
                    <i class="bi bi-trash"></i>
                </button>
            </div>
        `;
        
        document.getElementById('approvalFilesList').insertAdjacentHTML('beforeend', fileItem);
    }
    
    function removeApprovalFile(fileId) {
        // Remove from array
        selectedApprovalFiles = selectedApprovalFiles.filter(f => f.id !== fileId);
        
        // Remove from UI
        document.getElementById(`approvalFile-${fileId}`)?.remove();
        document.getElementById(`hiddenApprovalFile-${fileId}`)?.remove();
        
        updateApprovalFilesDisplay();
    }

    function createHiddenApprovalInput(fileObj) {
        const input = document.createElement('input');
        input.type = 'file';
        input.name = 'ApprovalFiles';
        input.id = `hiddenApprovalFile-${fileObj.id}`;
        input.style.display = 'none';
        
        // Create a DataTransfer object to set the file
        const dataTransfer = new DataTransfer();
        dataTransfer.items.add(fileObj.file);
        input.files = dataTransfer.files;
        
        document.getElementById('hiddenApprovalFileInputs').appendChild(input);
    }
    
    function updateApprovalFilesDisplay() {
        const noFilesMsg = document.getElementById('noApprovalFilesMessage');
        
        if (selectedApprovalFiles.length === 0) {
            noFilesMsg.style.display = 'block';
        } else {
            noFilesMsg.style.display = 'none';
        }
    }

    function formatFileSize(bytes) {
        if (bytes === 0) return '0 Bytes';
        const k = 1024;
        const sizes = ['Bytes', 'KB', 'MB', 'GB'];
        const i = Math.floor(Math.log(bytes) / Math.log(k));
        return parseFloat((bytes / Math.pow(k, i)).toFixed(2)) + ' ' + sizes[i];
    }
    
    function getFileIcon(filename) {
        const ext = filename.toLowerCase().split('.').pop();
        const icons = {
            'pdf': 'bi-file-earmark-pdf',
            'doc': 'bi-file-earmark-word',
            'docx': 'bi-file-earmark-word',
            'xls': 'bi-file-earmark-excel',
            'xlsx': 'bi-file-earmark-excel',
            'ppt': 'bi-file-earmark-ppt',
            'pptx': 'bi-file-earmark-ppt',
            'jpg': 'bi-file-earmark-image',
            'jpeg': 'bi-file-earmark-image',
            'png': 'bi-file-earmark-image',
            'gif': 'bi-file-earmark-image'
        };
        return icons[ext] || 'bi-file-earmark';
    }

    // Make functions global
    window.removeApprovalFile = removeApprovalFile;
    </script>
}
