@model Ideku.Models.Statistics.DashboardData
@{
    ViewData["Title"] = "Dashboard";
}

@section Styles {
    <link href="~/css/pages/dashboard.css" rel="stylesheet" asp-append-version="true" />
    <link rel="stylesheet" href="https://cdn.jsdelivr.net/npm/flatpickr/dist/flatpickr.min.css">
}

<div class="container-fluid">

    <div class="page-header mb-4">
        <h2 class="page-title text-gradient">
            <i class="bi bi-speedometer2 me-2"></i>Dashboard
        </h2>
        <p class="text-muted">Idea Management System Statistics</p>
    </div>

    @if (Model != null && Model.HasAlerts)
    {
        <div class="alert alert-warning alert-dismissible fade show mb-4" role="alert">
            <i class="bi bi-exclamation-triangle-fill me-2"></i>
            <strong>Attention!</strong> @Model.UrgentActingExpirations acting roles expiring within 3 days.
            <a href="@Url.Action("Index", "UserManagement")" class="alert-link">Review now</a>
            <button type="button" class="btn-close" data-bs-dismiss="alert"></button>
        </div>
    }

    @if (Model != null)
    {
        <!-- Date Range Filter -->
        <div class="card mb-4">
            <div class="card-header">
                <h6 class="mb-0">
                    <i class="bi bi-calendar-range me-2"></i>Submission Date Period
                </h6>
            </div>
            <div class="card-body">
                <div class="row g-3">
                    <div class="col-auto">
                        <div class="list-group list-group-sm">
                            <button type="button" class="list-group-item list-group-item-action date-filter-btn" data-filter="today">
                                Today
                            </button>
                            <button type="button" class="list-group-item list-group-item-action date-filter-btn" data-filter="yesterday">
                                Yesterday
                            </button>
                            <button type="button" class="list-group-item list-group-item-action date-filter-btn" data-filter="thisWeek">
                                This Week
                            </button>
                            <button type="button" class="list-group-item list-group-item-action date-filter-btn" data-filter="lastWeek">
                                Last Week
                            </button>
                            <button type="button" class="list-group-item list-group-item-action date-filter-btn" data-filter="thisMonth">
                                This Month
                            </button>
                            <button type="button" class="list-group-item list-group-item-action date-filter-btn" data-filter="lastMonth">
                                Last Month
                            </button>
                            <div class="mt-3">
                                <div class="input-group input-group-sm mb-2">
                                    <input type="number" class="form-control" id="daysUpToToday" placeholder="1" min="1" value="1" style="max-width: 50px;">
                                    <span class="input-group-text text-nowrap small">days up to today</span>
                                </div>
                                <div class="input-group input-group-sm">
                                    <input type="number" class="form-control" id="daysFromToday" placeholder="1" min="1" value="1" style="max-width: 50px;">
                                    <span class="input-group-text text-nowrap small">days starting today</span>
                                </div>
                            </div>
                        </div>
                    </div>
                    <div class="col">
                        <div class="row g-2 mb-3">
                            <div class="col-auto">
                                <label class="form-label small mb-1">Start Date</label>
                                <input type="text" class="form-control form-control-sm" id="startDateDisplay" placeholder="Select start date" readonly style="width: 150px;">
                            </div>
                            <div class="col-auto">
                                <label class="form-label small mb-1">End Date</label>
                                <input type="text" class="form-control form-control-sm" id="endDateDisplay" placeholder="Select end date" readonly style="width: 150px;">
                            </div>
                        </div>
                        <div class="calendar-container mb-3">
                            <input type="text" id="dateRange" style="display: none;">
                        </div>
                        <div class="d-flex gap-2">
                            <button type="button" class="btn btn-outline-secondary btn-sm" id="clearDateFilter">
                                <i class="bi bi-x-circle me-2"></i>Clear Filter
                            </button>
                            <button type="button" class="btn btn-success btn-sm" id="exportDashboard">
                                <i class="bi bi-file-earmark-excel me-2"></i>Export to Excel
                            </button>

                            <!-- Hidden form for export -->
                            <form id="exportForm" method="get" action="@Url.Action("ExportDashboard", "Home")" style="display: none;">
                                <input type="hidden" name="startDate" id="exportStartDate" />
                                <input type="hidden" name="endDate" id="exportEndDate" />
                                <input type="hidden" name="selectedDivision" id="exportDivision" />
                                <input type="hidden" name="selectedStage" id="exportStage" />
                                <input type="hidden" name="savingCostRange" id="exportSavingCost" />
                            </form>
                        </div>
                    </div>
                </div>
            </div>
        </div>

        <!-- Dashboard Filters Card -->
        <div class="card mb-4">
            <div class="card-header">
                <h6 class="mb-0">
                    <i class="bi bi-funnel me-2"></i>Filters
                </h6>
            </div>
            <div class="card-body">
                <div class="row g-3">

                    <!-- Division Filter -->
                    <div class="col-lg-4 col-md-6">
                        <label class="form-label small mb-1">Division</label>
                        <select id="filterDivision" class="form-select form-select-sm">
                            <option value="">All Divisions</option>
                            @if (ViewBag.Divisions != null)
                            {
                                @foreach (var division in (IEnumerable<Microsoft.AspNetCore.Mvc.Rendering.SelectListItem>)ViewBag.Divisions)
                                {
                                    if (!string.IsNullOrEmpty(division.Value))
                                    {
                                        <option value="@division.Value"
                                                selected="@(ViewBag.SelectedDivision == division.Value)">
                                            @division.Text
                                        </option>
                                    }
                                }
                            }
                        </select>
                    </div>

                    <!-- Stage Filter -->
                    <div class="col-lg-4 col-md-6">
                        <label class="form-label small mb-1">Stage</label>
                        <select id="filterStage" class="form-select form-select-sm">
                            <option value="">All Stages</option>
                            @if (ViewBag.AvailableStages != null)
                            {
                                @foreach (var stage in (IEnumerable<Microsoft.AspNetCore.Mvc.Rendering.SelectListItem>)ViewBag.AvailableStages)
                                {
                                    <option value="@stage.Value" selected="@(ViewBag.SelectedStage?.ToString() == stage.Value)">@stage.Text</option>
                                }
                            }
                        </select>
                    </div>

                    <!-- Saving Cost Filter -->
                    <div class="col-lg-4 col-md-6">
                        <label class="form-label small mb-1">Saving Cost</label>
                        <select id="filterSavingCost" class="form-select form-select-sm">
                            <option value="">All Saving Costs</option>
                            <option value="lt20k" selected="@(ViewBag.SavingCostRange == "lt20k")">Less than $20,000</option>
                            <option value="gte20k" selected="@(ViewBag.SavingCostRange == "gte20k")">More than $20,000</option>
                        </select>
                    </div>

                </div>

                <!-- Clear Filters Button -->
                <div class="mt-3">
                    <button type="button" class="btn btn-outline-secondary btn-sm" id="clearAllFilters">
                        <i class="bi bi-x-circle me-2"></i>Clear All Filters
                    </button>
                </div>
            </div>
        </div>

        <!-- Statistics Cards -->
        <div class="row g-4 mb-4">
            <div class="col-lg-6">
                <div class="card stat-card h-100">
                    <div class="card-body">
                        <div class="d-flex align-items-center">
                            <div class="stat-icon bg-primary bg-opacity-10 text-primary">
                                <i class="bi bi-lightbulb-fill"></i>
                            </div>
                            <div class="ms-3 flex-grow-1">
                                <h6 class="text-muted mb-1">Total Ideas</h6>
                                <h2 class="mb-0">@Model.TotalIdeas</h2>
                            </div>
                        </div>
                    </div>
                </div>
            </div>

            <div class="col-lg-6">
                <div class="card stat-card h-100">
                    <div class="card-body">
                        <div class="d-flex align-items-center">
                            <div class="stat-icon bg-success bg-opacity-10 text-success">
                                <i class="bi bi-currency-dollar"></i>
                            </div>
                            <div class="ms-3 flex-grow-1">
                                <h6 class="text-muted mb-1">Saving Cost</h6>
                                <h2 class="mb-0">$ @Model.TotalSavingCost.ToString("N0")</h2>
                                <small class="text-muted">Validated: $ @Model.ValidatedSavingCost.ToString("N0")</small>
                            </div>
                        </div>
                    </div>
                </div>
            </div>
        </div>

        <!-- Division Chart -->
        <div class="row g-4 mb-4">
            <div class="col-12">
                <div class="card">
                    <div class="card-header d-flex justify-content-between align-items-center">
                        <h6 class="mb-0">
                            <i class="bi bi-building me-2"></i><span id="divisionChartTitle">Count of Initiative by Divisions</span>
                        </h6>
                        <nav id="divisionBreadcrumb" aria-label="breadcrumb" style="display: none;">
                            <ol class="breadcrumb mb-0">
                                <li class="breadcrumb-item">
                                    <a href="#" id="breadcrumbDivisions" class="text-decoration-none">Initiative</a>
                                </li>
                                <li class="breadcrumb-item active" aria-current="page" id="breadcrumbCurrentDivision"></li>
                            </ol>
                        </nav>
                    </div>
                    <div class="card-body">
                        <canvas id="divisionChart" height="80"></canvas>
                    </div>
                </div>
            </div>
        </div>

        <!-- All Departments Chart -->
        <div class="row g-4 mb-4">
            <div class="col-12">
                <div class="card">
                    <div class="card-header">
                        <h6 class="mb-0">
                            <i class="bi bi-diagram-3 me-2"></i>Count of Initiative by Departments
                        </h6>
                    </div>
                    <div class="card-body">
                        <canvas id="allDepartmentsChart" height="80"></canvas>
                    </div>
                </div>
            </div>
        </div>

        <!-- Charts Section -->
        <div class="row g-4 mb-4">
            <div class="col-lg-8">
                <div class="card h-100">
                    <div class="card-header">
                        <h6 class="mb-0">
                            <i class="bi bi-bar-chart-steps me-2"></i>Initiative by Stage and Division
                        </h6>
                    </div>
                    <div class="card-body">
                        <canvas id="stageByDivisionChart" height="200"></canvas>
                    </div>
                </div>
            </div>

            <div class="col-lg-4">
                <div class="card h-100">
                    <div class="card-header">
                        <h6 class="mb-0">
                            <i class="bi bi-pie-chart me-2"></i>Count of Initiative by Stage
                        </h6>
                    </div>
                    <div class="card-body" style="padding-bottom: 20px;">
                        <canvas id="statusChart" height="400"></canvas>
                    </div>
                </div>
            </div>
        </div>
    }
    else
    {
        <div class="alert alert-danger">
            <i class="bi bi-exclamation-triangle me-2"></i>
            Unable to load dashboard data. Please refresh the page.
        </div>
    }
</div>

@section Scripts {
    <script src="https://cdn.jsdelivr.net/npm/chart.js@4.4.0"></script>
    <script src="https://cdn.jsdelivr.net/npm/flatpickr"></script>
    <script src="~/js/pages/dashboard.js" asp-append-version="true"></script>
}
