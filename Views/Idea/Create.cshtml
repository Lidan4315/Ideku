@model Ideku.ViewModels.CreateIdeaViewModel
@{
    ViewData["Title"] = "Submit New Idea";
}

<div class="container-fluid">
    <div class="row">
        <div class="col-12">
            <!-- Page Header -->
            <div class="page-header-modern mb-4">
                <h1 class="page-title text-gradient mb-0">
                    Submit New Idea
                </h1>
            </div>

            <form id="createIdeaForm" asp-action="Create" method="post" enctype="multipart/form-data">
                @Html.AntiForgeryToken()
                
                <!-- Hidden Fields -->
                <input asp-for="InitiatorUserId" type="hidden"/>
                <input asp-for="EmployeeId" type="hidden"/>

                <!-- Initiator Profile Section -->
                <div class="card mb-4">
                    <div class="card-header">
                        <h5 class="card-title mb-0">
                            <i class="bi bi-person-badge me-2"></i>Initiator Profile
                        </h5>
                    </div>
                    <div class="card-body">
                        <div class="row">
                            <div class="col-md-12">
                                <div class="mb-3">
                                    <label asp-for="BadgeNumber" class="form-label">Badge Number <span class="text-danger">*</span></label>
                                    <input asp-for="BadgeNumber" class="form-control" id="badgeNumberInput" placeholder="Enter badge number" />
                                    <small class="form-text text-muted">Enter badge number to auto-populate employee info</small>
                                    <span asp-validation-for="BadgeNumber" class="text-danger"></span>
                                </div>
                            </div>
                        </div>
                        <div class="row" id="employeeInfoContainer" style="display: none;">
                            <div class="col-md-6">
                                <div class="mb-3">
                                    <label class="form-label">Employee Name</label>
                                    <input asp-for="EmployeeName" class="form-control" readonly />
                                </div>
                            </div>
                            <div class="col-md-6">
                                <div class="mb-3">
                                    <label class="form-label">Position</label>
                                    <input asp-for="Position" class="form-control" readonly />
                                </div>
                            </div>
                            <div class="col-md-6">
                                <div class="mb-3">
                                    <label class="form-label">Division</label>
                                    <input asp-for="Division" class="form-control" readonly />
                                </div>
                            </div>
                            <div class="col-md-6">
                                <div class="mb-3">
                                    <label class="form-label">Department</label>
                                    <input asp-for="Department" class="form-control" readonly />
                                </div>
                            </div>
                            <div class="col-md-12">
                                <div class="mb-3">
                                    <label class="form-label">Email</label>
                                    <input asp-for="Email" class="form-control" readonly />
                                </div>
                            </div>
                        </div>
                    </div>
                </div>

                <!-- Idea Details, Financial Impact & Attachments Section -->
                <div class="card mb-4">
                    <div class="card-header">
                        <h5 class="card-title mb-0">
                            <i class="bi bi-lightbulb me-2"></i>Idea Details
                        </h5>
                    </div>
                    <div class="card-body">
                        <!-- Division & Department Row -->
                        <div class="row">
                            <div class="col-md-6">
                                <div class="mb-3">
                                    <label asp-for="ToDivisionId" class="form-label">To Division <span class="text-danger">*</span></label>
                                    <select asp-for="ToDivisionId" class="form-select" asp-items="Model.DivisionList" id="divisionSelect">
                                    </select>
                                    <small class="form-text text-muted">Which division is this idea intended for?</small>
                                    <span asp-validation-for="ToDivisionId" class="text-danger"></span>
                                </div>
                            </div>
                            <div class="col-md-6">
                                <div class="mb-3">
                                    <label asp-for="ToDepartmentId" class="form-label">To Department <span class="text-danger">*</span></label>
                                    <select asp-for="ToDepartmentId" class="form-select" asp-items="Model.DepartmentList" id="departmentSelect" disabled>
                                    </select>
                                    <small class="form-text text-muted">Which department is this idea intended for?</small>
                                    <span asp-validation-for="ToDepartmentId" class="text-danger"></span>
                                </div>
                            </div>
                        </div>

                        <!-- Category & Event Row -->
                        <div class="row">
                            <div class="col-md-6">
                                <div class="mb-3">
                                    <label asp-for="CategoryId" class="form-label">Category <span class="text-danger">*</span></label>
                                    <select asp-for="CategoryId" class="form-select" asp-items="Model.CategoryList">
                                    </select>
                                    <span asp-validation-for="CategoryId" class="text-danger"></span>
                                </div>
                            </div>
                            <div class="col-md-6">
                                <div class="mb-3">
                                    <label asp-for="EventId" class="form-label">Event</label>
                                    <select asp-for="EventId" class="form-select" asp-items="Model.EventList">
                                    </select>
                                    <small class="form-text text-muted">Event selection is optional</small>
                                    <span asp-validation-for="EventId" class="text-danger"></span>
                                </div>
                            </div>
                        </div>

                        <!-- Idea Name -->
                        <div class="mb-3">
                            <label asp-for="IdeaName" class="form-label">Idea Name <span class="text-danger">*</span></label>
                            <input asp-for="IdeaName" class="form-control" id="ideaNameInput" placeholder="Give your idea a catchy title" />
                            <small class="form-text text-muted">Give your idea a catchy title</small>
                            <span asp-validation-for="IdeaName" class="text-danger" id="ideaNameValidation"></span>
                        </div>

                        <!-- Idea Description -->
                        <div class="mb-3">
                            <label asp-for="IdeaDescription" class="form-label">Idea Description <span class="text-danger">*</span></label>
                            <textarea asp-for="IdeaDescription" class="form-control" rows="5" placeholder="Describe the problem or issue this idea addresses"></textarea>
                            <small class="form-text text-muted">What problem does your idea solve?</small>
                            <span asp-validation-for="IdeaDescription" class="text-danger"></span>
                        </div>

                        <!-- Solution -->
                        <div class="mb-3">
                            <label asp-for="Solution" class="form-label">Solution <span class="text-danger">*</span></label>
                            <textarea asp-for="Solution" class="form-control" rows="5" placeholder="Explain your proposed solution"></textarea>
                            <small class="form-text text-muted">How would you implement this idea?</small>
                            <span asp-validation-for="Solution" class="text-danger"></span>
                        </div>

                        <!-- Saving Cost -->
                        <div class="mb-4">
                            <label asp-for="SavingCost" class="form-label">Saving Cost (USD) <span class="text-danger">*</span></label>
                            <div class="input-group">
                                <span class="input-group-text">USD</span>
                                <input asp-for="SavingCost" type="text" class="form-control" id="savingCostInput" placeholder="Enter amount" />
                            </div>
                            <small class="form-text text-muted">Estimated cost savings (e.g., 1,000 or 1,000,000)</small>
                            <span asp-validation-for="SavingCost" class="text-danger"></span>
                        </div>

                        <!-- Attachments -->
                        <div class="mb-4">
                            <label class="form-label">Attachments <span class="text-muted">(Optional)</span></label>

                            <!-- File Upload Container with Dashed Border -->
                            <div class="file-upload-container">
                                <input type="file" id="fileInput" class="d-none" accept=".pdf,.doc,.docx,.xls,.xlsx,.ppt,.pptx,.jpg,.jpeg,.png" multiple />

                                <!-- Browse Files Button -->
                                <div class="file-upload-header">
                                    <button type="button" class="btn btn-outline-primary" onclick="document.getElementById('fileInput').click()">
                                        <i class="bi bi-folder2-open me-2"></i><span class="d-none d-md-inline">Browse Files</span><span class="d-inline d-md-none">Browse</span>
                                    </button>
                                    <small class="form-text text-muted ms-2 d-none d-md-inline">Select one or multiple files. Accepted: PDF, DOC, DOCX, XLS, XLSX, PPT, PPTX, JPG, PNG (Max 10 MB total)</small>
                                </div>

                                <!-- Mobile File Info (shown below button on mobile) -->
                                <small class="form-text text-muted d-block d-md-none mt-2">
                                    Accepted: PDF, DOC, DOCX, XLS, XLSX, PPT, PPTX, JPG, PNG (Max 10 MB total)
                                </small>

                                <!-- Selected Files List -->
                                <div id="filesList" class="files-list-container">
                                    <div class="text-muted text-center" id="noFilesMessage">
                                        <i class="bi bi-cloud-arrow-up fs-1 d-block mb-2"></i>
                                        No files added yet
                                    </div>
                                </div>
                            </div>

                            <!-- Hidden inputs for files -->
                            <div id="hiddenFileInputs"></div>

                            <span asp-validation-for="AttachmentFiles" class="text-danger"></span>
                        </div>

                        <!-- Action Buttons -->
                        <div class="text-end">
                            <button type="submit" class="btn btn-primary" id="submitBtn">
                                <i class="bi bi-check-circle me-2"></i>Submit Idea
                            </button>
                        </div>
                    </div>
                </div>
            </form>
        </div>
    </div>
</div>

@section Scripts {
    @{await Html.RenderPartialAsync("_ValidationScriptsPartial");}

    <script>
        $(document).ready(function() {
            // ============================================================================
            // CONSTANTS & CONFIGURATION
            // ============================================================================
            const DEBOUNCE_DELAY = 500; // milliseconds
            const CUSTOM_VALIDATED_FIELDS = ['ideaNameInput', 'badgeNumberInput'];
            const FILE_CONFIG = {
                allowedExtensions: ['.pdf', '.doc', '.docx', '.xls', '.xlsx', '.ppt', '.pptx', '.jpg', '.jpeg', '.png'],
                maxSizePerFile: 10 * 1024 * 1024, // 10MB
                maxTotalSize: 10 * 1024 * 1024    // 10MB
            };

            // ============================================================================
            // UTILITY FUNCTIONS
            // ============================================================================

            // Generic debounce function
            function debounce(callback, delay) {
                let timer;
                return function(...args) {
                    clearTimeout(timer);
                    timer = setTimeout(() => callback.apply(this, args), delay);
                };
            }

            // Clear employee info fields
            function clearEmployeeFields() {
                $('#EmployeeName, #Position, #Division, #Department, #Email, #EmployeeId').val('');
            }

            // Show field error
            function showFieldError(field, message) {
                field.addClass('is-invalid');
                const validationSpan = field.siblings('span[data-valmsg-for]').first();
                if (validationSpan.length) {
                    validationSpan.text(message);
                }
            }

            // Clear field error
            function clearFieldError(field) {
                field.removeClass('is-invalid');
                const validationSpan = field.siblings('span[data-valmsg-for]').first();
                if (validationSpan.length) {
                    validationSpan.text('');
                }
            }

            // ============================================================================
            // BADGE NUMBER VALIDATION
            // ============================================================================

            const badgeNumberInput = $('#badgeNumberInput');
            const employeeInfoContainer = $('#employeeInfoContainer');

            const validateBadgeNumber = debounce(function(badgeNumber) {
                if (!badgeNumber) {
                    employeeInfoContainer.slideUp();
                    clearEmployeeFields();
                    clearFieldError(badgeNumberInput);
                    return;
                }

                clearFieldError(badgeNumberInput);

                $.get('/Idea/GetEmployeeByBadgeNumber', { badgeNumber: badgeNumber })
                    .done(function(response) {
                        if (response.success) {
                            // Populate employee info
                            $('#EmployeeName').val(response.data.name);
                            $('#Position').val(response.data.position);
                            $('#Division').val(response.data.division);
                            $('#Department').val(response.data.department);
                            $('#Email').val(response.data.email);
                            $('#EmployeeId').val(response.data.employeeId);
                            employeeInfoContainer.slideDown();
                        } else {
                            employeeInfoContainer.slideUp();
                            clearEmployeeFields();
                            showFieldError(badgeNumberInput, 'Badge number not found. Please check and try again.');
                        }
                    })
                    .fail(function() {
                        employeeInfoContainer.slideUp();
                        clearEmployeeFields();
                        showFieldError(badgeNumberInput, 'Error connecting to server. Please try again.');
                    });
            }, DEBOUNCE_DELAY);

            badgeNumberInput.on('input', function() {
                validateBadgeNumber($(this).val().trim());
            });

            // ============================================================================
            // IDEA NAME VALIDATION
            // ============================================================================

            const ideaNameInput = $('#ideaNameInput');
            const ideaNameValidation = $('#ideaNameValidation');

            const validateIdeaName = debounce(function(ideaName) {
                if (!ideaName) {
                    ideaNameInput.removeClass('is-invalid is-valid');
                    ideaNameValidation.empty();
                    return;
                }

                // Show checking indicator
                ideaNameValidation.html('<i class="bi bi-hourglass-split"></i> Checking availability...')
                    .removeClass('text-danger text-success').addClass('text-muted');

                $.get('/Idea/CheckIdeaNameExists', { ideaName: ideaName })
                    .done(function(response) {
                        if (response.exists) {
                            ideaNameInput.removeClass('is-valid').addClass('is-invalid');
                            ideaNameValidation.removeClass('text-muted text-success').addClass('text-danger')
                                .html('This idea name already exists. Please use a different name.');
                        } else {
                            ideaNameInput.removeClass('is-invalid').addClass('is-valid');
                            ideaNameValidation.removeClass('text-muted text-danger').addClass('text-success')
                                .html('Idea name is available');
                        }
                    })
                    .fail(function() {
                        ideaNameValidation.removeClass('text-muted text-success').addClass('text-danger')
                            .html('<i class="bi bi-exclamation-triangle-fill"></i> Error checking idea name. Please try again.');
                    });
            }, DEBOUNCE_DELAY);

            ideaNameInput.on('input', function() {
                ideaNameInput.removeClass('is-invalid is-valid');
                ideaNameValidation.empty();
                validateIdeaName($(this).val().trim());
            });

            // Remove green visual feedback when user leaves the field (keep red error)
            ideaNameInput.on('blur', function() {
                if (ideaNameInput.hasClass('is-valid')) {
                    ideaNameInput.removeClass('is-valid');
                    ideaNameValidation.empty();
                }
            });

            // ============================================================================
            // SAVING COST FORMATTING
            // ============================================================================

            const savingCostInput = $('#savingCostInput');

            // Format number with thousand separator
            function formatNumberWithCommas(value) {
                return value.replace(/\B(?=(\d{3})+(?!\d))/g, ',');
            }

            savingCostInput.on('input', function() {
                const value = $(this).val();
                const numericValue = value.replace(/[^\d]/g, '');

                if (numericValue) {
                    $(this).attr('data-numeric-value', numericValue);
                    $(this).val(formatNumberWithCommas(numericValue));
                    $(this)[0].setCustomValidity('');
                } else {
                    $(this).removeAttr('data-numeric-value');
                    $(this)[0].setCustomValidity('Saving Cost is required');
                }

                $(this).valid();
            });

            // ============================================================================
            // DIVISION-DEPARTMENT CASCADE
            // ============================================================================

            const divisionSelect = $('#divisionSelect');
            const departmentSelect = $('#departmentSelect');

            divisionSelect.change(function() {
                const divisionId = $(this).val();

                if (divisionId) {
                    departmentSelect.prop('disabled', false)
                        .html('<option value="">Loading departments...</option>');

                    $.get('/Idea/GetDepartmentsByDivision', { divisionId: divisionId })
                        .done(function(data) {
                            departmentSelect.empty()
                                .append('<option value="">-- Select To Department --</option>');

                            $.each(data, function(index, item) {
                                departmentSelect.append($('<option>', {
                                    value: item.id,
                                    text: item.name
                                }));
                            });
                        })
                        .fail(function() {
                            departmentSelect.html('<option value="">Error loading departments</option>');
                        });
                } else {
                    departmentSelect.prop('disabled', true)
                        .html('<option value="">-- Select To Division First --</option>');
                }
            });

            // ============================================================================
            // FILE UPLOAD HANDLER
            // ============================================================================

            let selectedFiles = [];
            let fileCounter = 0;

            // Validate file
            function validateFile(file, currentTotalSize) {
                const fileName = file.name.toLowerCase();
                const fileExt = fileName.substring(fileName.lastIndexOf('.'));

                if (!FILE_CONFIG.allowedExtensions.includes(fileExt)) {
                    return `File type '${fileExt}' is not allowed. Allowed types: ${FILE_CONFIG.allowedExtensions.join(', ')}`;
                }

                if (file.size > FILE_CONFIG.maxSizePerFile) {
                    const fileSizeMB = (file.size / (1024 * 1024)).toFixed(2);
                    return `File '${file.name}' (${fileSizeMB} MB) exceeds the maximum size of 10 MB per file`;
                }

                return null;
            }

            $('#fileInput').change(function() {
                const files = Array.from(this.files);
                if (!files.length) return;

                const currentTotalSize = selectedFiles.reduce((sum, f) => sum + f.size, 0);
                let newFilesSize = 0;
                const validFiles = [];
                let errorMessage = '';

                // Validate each file
                for (const file of files) {
                    errorMessage = validateFile(file, currentTotalSize);
                    if (errorMessage) break;

                    newFilesSize += file.size;
                    validFiles.push(file);
                }

                // Check total size
                const totalSizeAfterAdd = currentTotalSize + newFilesSize;
                if (!errorMessage && totalSizeAfterAdd > FILE_CONFIG.maxTotalSize) {
                    const totalSizeMB = (totalSizeAfterAdd / (1024 * 1024)).toFixed(2);
                    const maxTotalMB = (FILE_CONFIG.maxTotalSize / (1024 * 1024)).toFixed(0);
                    errorMessage = `Total file size (${totalSizeMB} MB) would exceed the maximum allowed total size of ${maxTotalMB} MB`;
                }

                if (errorMessage) {
                    Swal.fire({
                        icon: 'warning',
                        title: 'File Validation Failed',
                        text: errorMessage,
                        confirmButtonText: 'OK'
                    });
                    this.value = '';
                    return;
                }

                // Add valid files
                validFiles.forEach(file => {
                    const fileObj = {
                        id: fileCounter++,
                        file: file,
                        name: file.name,
                        size: file.size,
                        type: file.type
                    };

                    selectedFiles.push(fileObj);
                    addFileToList(fileObj);
                    createHiddenInput(fileObj);
                });

                updateFilesDisplay();
                this.value = '';
            });
            
            function addFileToList(fileObj) {
                const fileSize = formatFileSize(fileObj.size);
                const fileIcon = getFileIcon(fileObj.name);
                
                const fileItem = `
                    <div class="d-flex align-items-center justify-content-between p-2 border rounded mb-2 bg-white" id="file-${fileObj.id}">
                        <div class="d-flex align-items-center">
                            <i class="bi ${fileIcon} fs-4 me-3 text-primary"></i>
                            <div>
                                <div class="fw-medium">${fileObj.name}</div>
                                <small class="text-muted">${fileSize}</small>
                            </div>
                        </div>
                        <button type="button" class="btn btn-outline-danger btn-sm" onclick="removeFile(${fileObj.id})">
                            <i class="bi bi-trash"></i>
                        </button>
                    </div>
                `;
                
                $('#filesList').append(fileItem);
            }
            
            function removeFile(fileId) {
                // Remove from array
                selectedFiles = selectedFiles.filter(f => f.id !== fileId);
                
                // Remove from UI
                $(`#file-${fileId}`).remove();
                $(`#hiddenFile-${fileId}`).remove();
                
                updateFilesDisplay();
            }
            
            function createHiddenInput(fileObj) {
                const input = $(`<input type="file" name="AttachmentFiles" id="hiddenFile-${fileObj.id}" style="display:none" />`);
                
                // Create a DataTransfer object to set the file
                const dataTransfer = new DataTransfer();
                dataTransfer.items.add(fileObj.file);
                input[0].files = dataTransfer.files;
                
                $('#hiddenFileInputs').append(input);
            }
            
            function updateFilesDisplay() {
                const noFilesMsg = $('#noFilesMessage');
                
                if (selectedFiles.length === 0) {
                    noFilesMsg.show();
                } else {
                    noFilesMsg.hide();
                }
            }
            
            function formatFileSize(bytes) {
                if (bytes === 0) return '0 Bytes';
                const k = 1024;
                const sizes = ['Bytes', 'KB', 'MB', 'GB'];
                const i = Math.floor(Math.log(bytes) / Math.log(k));
                return parseFloat((bytes / Math.pow(k, i)).toFixed(2)) + ' ' + sizes[i];
            }
            
            function getFileIcon(filename) {
                const ext = filename.toLowerCase().split('.').pop();
                const icons = {
                    'pdf': 'bi-file-earmark-pdf',
                    'doc': 'bi-file-earmark-word',
                    'docx': 'bi-file-earmark-word',
                    'xls': 'bi-file-earmark-excel',
                    'xlsx': 'bi-file-earmark-excel',
                    'ppt': 'bi-file-earmark-ppt',
                    'pptx': 'bi-file-earmark-ppt',
                    'jpg': 'bi-file-earmark-image',
                    'jpeg': 'bi-file-earmark-image',
                    'png': 'bi-file-earmark-image',
                    'gif': 'bi-file-earmark-image'
                };
                return icons[ext] || 'bi-file-earmark';
            }
            
            // Expose removeFile globally
            window.removeFile = removeFile;

            // ============================================================================
            // REAL-TIME VALIDATION FEEDBACK
            // ============================================================================

            // Cache custom validated fields as jQuery objects for performance
            const customValidatedElements = $('#' + CUSTOM_VALIDATED_FIELDS.join(', #'));

            // Blur validation for required fields
            $('.form-control[required], .form-select[required]').on('blur', function() {
                const field = $(this);

                // Skip custom validated fields
                if (customValidatedElements.is(field)) return;

                const fieldValue = field.val();
                if (!fieldValue || fieldValue.trim() === '') {
                    field.addClass('is-invalid');
                } else {
                    field.removeClass('is-invalid');
                }
            });

            // Remove error on input - separate handlers for input and change to avoid double firing
            $('.form-control').not(customValidatedElements).on('input', function() {
                const field = $(this);
                if (field.val() && field.val().trim() !== '') {
                    field.removeClass('is-invalid');
                }
            });

            $('.form-select').not(customValidatedElements).on('change', function() {
                const field = $(this);
                if (field.val() && field.val().trim() !== '') {
                    field.removeClass('is-invalid');
                }
            });

            // ============================================================================
            // FORM SUBMISSION VALIDATION HELPERS
            // ============================================================================

            function showValidationErrors() {
                // Only process fields with validation errors (much faster)
                $('span.field-validation-error').each(function() {
                    const fieldName = $(this).data('valmsg-for');
                    if (fieldName) {
                        $('[name="' + fieldName + '"]').addClass('is-invalid');
                    }
                });

                // Handle validation spans with error text (optimized selector)
                $('span[data-valmsg-for]').each(function() {
                    const errorText = $(this).text().trim();
                    if (errorText !== '') {
                        const forAttr = $(this).data('valmsg-for');
                        if (forAttr) {
                            $('[name="' + forAttr + '"]').addClass('is-invalid');
                        }
                    }
                });
            }

            function scrollToFirstError() {
                const firstError = $('.is-invalid').first();
                if (firstError.length) {
                    $('html, body').animate({
                        scrollTop: firstError.offset().top - 100
                    }, 100);
                }
            }

            // ============================================================================
            // FORM SUBMISSION
            // ============================================================================

            $('#createIdeaForm').submit(function(e) {
                e.preventDefault();

                // Validate form
                if (!$(this).valid()) {
                    showValidationErrors();
                    scrollToFirstError();
                    return;
                }

                // Check for duplicate idea name
                if (ideaNameInput.hasClass('is-invalid')) {
                    Swal.fire({
                        icon: 'warning',
                        title: 'Duplicate Idea Name',
                        text: 'This idea name already exists. Please use a different name.',
                        confirmButtonText: 'OK'
                    });
                    return;
                }

                // Convert saving cost to numeric
                const savingCostValue = savingCostInput.val().replace(/[^\d]/g, '');
                savingCostInput.val(savingCostValue);

                // Disable submit button
                const submitBtn = $('#submitBtn');
                submitBtn.prop('disabled', true)
                    .html('<span class="spinner-border spinner-border-sm me-2"></span>Submitting...');

                const formData = new FormData(this);
                
                $.ajax({
                    url: $(this).attr('action'),
                    type: 'POST',
                    data: formData,
                    processData: false,
                    contentType: false,
                    success: function(response) {
                        if (response.success) {
                            Swal.fire({
                                icon: 'success',
                                title: 'Success!',
                                text: response.message || 'Idea has been submitted successfully',
                                confirmButtonText: 'OK'
                            }).then(function() {
                                window.location.href = '/Idea/Index';
                            });
                        } else {
                            // Show server validation errors
                            if (response.errors && response.errors.length > 0) {
                                // Build error list from backend validation errors
                                var errorList = '<ul class="text-start mb-0">';
                                response.errors.forEach(function(error) {
                                    errorList += '<li>' + error + '</li>';
                                });
                                errorList += '</ul>';

                                Swal.fire({
                                    icon: 'warning',
                                    title: response.message || 'Validation Failed',
                                    html: errorList,
                                    confirmButtonText: 'OK'
                                });
                            } else {
                                Swal.fire({
                                    icon: 'error',
                                    title: 'Submission Failed',
                                    text: response.message || 'Failed to submit idea',
                                    confirmButtonText: 'Try Again'
                                });
                            }
                        }
                    },
                    error: function(xhr) {
                        var errorMessage = 'An unexpected error occurred';

                        // Try to get error message from response
                        if (xhr.responseJSON && xhr.responseJSON.message) {
                            errorMessage = xhr.responseJSON.message;
                        } else if (xhr.responseText) {
                            try {
                                var response = JSON.parse(xhr.responseText);
                                errorMessage = response.message || errorMessage;
                            } catch (e) {
                                // Keep default error message
                            }
                        }

                        Swal.fire({
                            icon: 'error',
                            title: 'Error!',
                            text: errorMessage,
                            confirmButtonText: 'Try Again'
                        });
                    },
                    complete: function() {
                        submitBtn.prop('disabled', false);
                        submitBtn.html('<i class="bi bi-check-circle me-2"></i>Submit Idea');
                    }
                });
            });
        });
    </script>
}
