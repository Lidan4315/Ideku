@model Ideku.ViewModels.IdeaMonitoring.MonitoringDetailViewModel
@{
    ViewData["Title"] = $"Monitoring Details - {Model.Idea.IdeaName}";
}

@section Styles {
    <link rel="stylesheet" href="~/css/pages/idea-monitoring-details.css" asp-append-version="true" />
}

<div class="container-fluid">
    @Html.AntiForgeryToken()

    <!-- Page Header -->
    <div class="page-header-modern mb-4">
        <h1 class="page-title text-gradient mb-3">
            Monthly Saving Monitoring
        </h1>

        <!-- Breadcrumb Navigation -->
        <nav aria-label="breadcrumb">
            <ol class="breadcrumb mb-0">
                <li class="breadcrumb-item">
                    <a href="@Url.Action("Index", "IdeaMonitoring")">Monitoring</a>
                </li>
                <li class="breadcrumb-item">Details</li>
                <li class="breadcrumb-item active" aria-current="page">@Model.Idea.IdeaCode</li>
            </ol>
        </nav>
    </div>

    @if (TempData["SuccessMessage"] != null)
    {
        <div class="alert alert-success alert-dismissible fade show" role="alert">
            <i class="bi bi-check-circle me-2"></i>
            @TempData["SuccessMessage"]
            <button type="button" class="btn-close" data-bs-dismiss="alert" aria-label="Close"></button>
        </div>
    }

    @if (TempData["ErrorMessage"] != null)
    {
        <div class="alert alert-danger alert-dismissible fade show" role="alert">
            <i class="bi bi-exclamation-triangle me-2"></i>
            @TempData["ErrorMessage"]
            <button type="button" class="btn-close" data-bs-dismiss="alert" aria-label="Close"></button>
        </div>
    }

    <!-- Inactive/Rejected Idea Warning Card -->
    @await Html.PartialAsync("_InactiveIdeaWarning", Model.Idea)

    @{
        // Determine if idea is inactive (auto-rejected) or rejected (manually rejected)
        var isDisabled = ViewBag.IsInactive == true || ViewBag.IsRejected == true;
        var sectionClass = ViewBag.IsInactive == true ? "inactive-section" : (ViewBag.IsRejected == true ? "rejected-section" : "");
    }

    <!-- Wrap monitoring section - disable if inactive or rejected -->
    <div class="@(isDisabled ? sectionClass + " position-relative" : "")">

    <!-- Monitoring Content -->
    @{
        ViewData["IsReadOnly"] = false;
        ViewData["CanEditCostSavings"] = Model.CanEditCostSavings;
        ViewData["CanValidateCostSavings"] = Model.CanValidateCostSavings;
    }

    @if (!Model.HasMonitoring && Model.CanEditCostSavings)
    {
        <!-- Action Button for Empty State -->
        <div class="d-flex gap-2 mb-4 justify-content-end">
            <button type="button" class="btn btn-outline-primary" data-bs-toggle="modal" data-bs-target="#createMonitoringModal">
                <i class="bi bi-plus-circle me-2"></i>Add Monitoring
            </button>
        </div>
    }

    @await Html.PartialAsync("_MonitoringTables", Model.Monitorings)

    <!-- Supporting Documents Section -->
    <div class="card shadow mb-4">
        <div class="card-header d-flex justify-content-between align-items-center">
            <h5 class="mb-0 font-weight-bold">
                <i class="bi bi-paperclip me-2"></i>Supporting Documents
            </h5>
            @if (Model.CanEditCostSavings)
            {
                <button type="button" class="btn btn-primary btn-sm" data-bs-toggle="modal" data-bs-target="#uploadAttachmentModal">
                    <i class="bi bi-upload me-md-2"></i><span class="d-none d-md-inline">Upload</span>
               </button>
            }
        </div>
        <div class="card-body">
            @await Html.PartialAsync("_IdeaAttachments", Model.Idea)
        </div>
    </div>
</div>

<!-- Include File Preview Modal -->
@await Html.PartialAsync("_FilePreviewModal")

<!-- Upload Attachment Modal -->
<div class="modal fade" id="uploadAttachmentModal" tabindex="-1" aria-labelledby="uploadAttachmentModalLabel" aria-hidden="true">
    <div class="modal-dialog modal-dialog-centered modal-lg">
        <div class="modal-content app-modal">
            <div class="modal-header app-modal-header">
                <div class="d-flex align-items-center">
                    <div class="modal-icon">
                        <i class="bi bi-upload"></i>
                    </div>
                    <h5 class="modal-title mb-0" id="uploadAttachmentModalLabel">Upload Supporting Documents</h5>
                </div>
                <button type="button" class="btn-close btn-close-white" data-bs-dismiss="modal" aria-label="Close"></button>
            </div>
            <form id="uploadAttachmentForm" enctype="multipart/form-data">
                <div class="modal-body app-modal-body">
                    <input type="hidden" name="IdeaId" value="@Model.Idea.Id" />

                    <div class="mb-3">
                        <label class="form-label fw-bold">Select Files</label>
                        <div class="file-upload-container">
                            <input type="file"
                                   id="attachmentFileInput"
                                   name="AttachmentFiles"
                                   class="d-none"
                                   multiple
                                   accept=".pdf,.doc,.docx,.xls,.xlsx,.ppt,.pptx,.jpg,.jpeg,.png" />

                            <div class="file-upload-header">
                                <button type="button" class="btn btn-outline-gray" onclick="document.getElementById('attachmentFileInput').click()">
                                    <i class="bi bi-folder2-open me-2"></i><span class="d-none d-md-inline">Browse Files</span><span class="d-inline d-md-none">Browse</span>
                                </button>
                                <small class="form-text text-muted ms-2 d-none d-md-inline">
                                    Allowed: PDF, Word, Excel, PowerPoint, Images
                                </small>
                            </div>

                            <!-- Mobile File Info (shown below button on mobile) -->
                            <small class="form-text text-muted d-block d-md-none mt-2">
                                Allowed: PDF, Word, Excel, PowerPoint, Images
                            </small>

                            <div class="files-list-container mt-3">
                                <div id="attachmentFilesList"></div>
                                <div id="noAttachmentFilesMessage" class="text-center text-muted py-3">
                                    <i class="bi bi-cloud-upload" style="font-size: 2rem; opacity: 0.5;"></i>
                                    <p class="mt-2 mb-0">No files selected</p>
                                </div>
                            </div>
                        </div>
                    </div>

                    <div id="hiddenAttachmentFileInputs"></div>
                </div>
                <div class="modal-footer app-modal-footer">
                    <button type="button" class="btn btn-light" data-bs-dismiss="modal">
                        <i class="bi bi-x-circle me-2"></i>Cancel
                    </button>
                    <button type="submit" class="btn btn-primary" id="uploadAttachmentBtn">
                        <i class="bi bi-upload me-2"></i>Upload Files
                    </button>
                </div>
            </form>
        </div>
    </div>
</div>

<!-- Add New KPI Modal -->
<div class="modal fade" id="addKpiModal" tabindex="-1" aria-labelledby="addKpiModalLabel" aria-hidden="true">
    <div class="modal-dialog modal-dialog-centered">
        <div class="modal-content app-modal">
            <div class="modal-header app-modal-header">
                <div class="d-flex align-items-center">
                    <div class="modal-icon">
                        <i class="bi bi-plus-circle"></i>
                    </div>
                    <h5 class="modal-title mb-0" id="addKpiModalLabel">Add New KPI</h5>
                </div>
                <button type="button" class="btn-close btn-close-white" data-bs-dismiss="modal" aria-label="Close"></button>
            </div>
            <form id="addKpiForm">
                <div class="modal-body app-modal-body">
                    <input type="hidden" name="IdeaId" value="@Model.Idea.Id" />

                    <div class="mb-3">
                        <label for="kpiName" class="form-label">KPI Name <span class="text-danger">*</span></label>
                        <input type="text" class="form-control" id="kpiName" name="KpiName"
                               maxlength="200" placeholder="e.g., Cable Usage, Energy Consumption" required />
                        <small class="form-text text-muted">Enter a unique name for this KPI</small>
                    </div>

                    <div class="mb-3">
                        <label for="measurementUnit" class="form-label">Measurement Unit <span class="text-danger">*</span></label>
                        <input type="text" class="form-control" id="measurementUnit" name="MeasurementUnit"
                               maxlength="20" placeholder="e.g., cm, kg, kWh, hours" required />
                        <small class="form-text text-muted">Enter the unit of measurement (max 20 characters)</small>
                    </div>

                    <div class="alert alert-info">
                        <i class="bi bi-info-circle me-2"></i>
                        The new KPI will automatically use the same monthly duration as your existing monitoring records.
                    </div>
                </div>
                <div class="modal-footer app-modal-footer">
                    <button type="button" class="btn btn-light" data-bs-dismiss="modal">Cancel</button>
                    <button type="submit" class="btn btn-primary">
                        <i class="bi bi-check-circle me-2"></i>Add KPI
                    </button>
                </div>
            </form>
        </div>
    </div>
</div>

<!-- Extend Duration Modal -->
<div class="modal fade" id="extendDurationModal" tabindex="-1" aria-labelledby="extendDurationModalLabel" aria-hidden="true">
    <div class="modal-dialog modal-dialog-centered">
        <div class="modal-content app-modal">
            <div class="modal-header app-modal-header">
                <div class="d-flex align-items-center">
                    <div class="modal-icon">
                        <i class="bi bi-calendar-plus"></i>
                    </div>
                    <h5 class="modal-title mb-0" id="extendDurationModalLabel">Extend Monitoring Duration</h5>
                </div>
                <button type="button" class="btn-close btn-close-white" data-bs-dismiss="modal" aria-label="Close"></button>
            </div>
            <form id="extendDurationForm">
                <div class="modal-body app-modal-body">
                    <input type="hidden" name="IdeaId" value="@Model.Idea.Id" />

                    <div class="mb-3">
                        <label for="additionalMonths" class="form-label">Additional Months <span class="text-danger">*</span></label>
                        <input type="number" class="form-control" id="additionalMonths" name="AdditionalMonths"
                               min="1" max="12" value="1" required />
                        <small class="form-text text-muted">Enter number of months to extend (1-12 months)</small>
                    </div>

                    <div class="alert alert-info">
                        <i class="bi bi-info-circle me-2"></i>
                        This will add new monthly monitoring records starting from the next month after the current monitoring period.
                    </div>
                </div>
                <div class="modal-footer app-modal-footer">
                    <button type="button" class="btn btn-light" data-bs-dismiss="modal">
                        <i class="bi bi-x-circle me-2"></i>Cancel
                    </button>
                    <button type="submit" class="btn btn-primary">
                        <i class="bi bi-check-circle me-2"></i>Extend Duration
                    </button>
                </div>
            </form>
        </div>
    </div>
</div>

<!-- Create Monitoring Modal -->
<div class="modal fade" id="createMonitoringModal" tabindex="-1" aria-labelledby="createMonitoringModalLabel" aria-hidden="true">
    <div class="modal-dialog modal-dialog-centered">
        <div class="modal-content app-modal">
            <div class="modal-header app-modal-header">
                <div class="d-flex align-items-center">
                    <div class="modal-icon">
                        <i class="bi bi-plus-circle"></i>
                    </div>
                    <div>
                        <h5 class="modal-title mb-0" id="createMonitoringModalLabel">Add Cost Saving Monitoring</h5>
                    </div>
                </div>
                <button type="button" class="btn-close" data-bs-dismiss="modal" aria-label="Close"></button>
            </div>
            <form id="createMonitoringForm">
                <div class="modal-body app-modal-body">
                    <input type="hidden" name="IdeaId" value="@Model.Idea.Id" />

                    <div class="mb-3">
                        <label for="monthFrom" class="form-label">Start Month <span class="text-danger">*</span></label>
                        <input type="month" class="form-control" id="monthFrom" name="MonthFrom" required
                               value="@DateTime.Now.ToString("yyyy-MM")" />
                    </div>

                    <div class="mb-3">
                        <label for="durationMonths" class="form-label">Duration (Months) <span class="text-danger">*</span></label>
                        <input type="number" class="form-control" id="durationMonths" name="DurationMonths"
                               min="1" max="24" value="12" required />
                        <small class="form-text text-muted">Duration must be between 1 and 24 months</small>
                    </div>

                    <div class="alert alert-info">
                        <i class="bi bi-info-circle me-2"></i>
                        This will create separate monitoring records for each month. You can then input the cost save plan and actual values for each month individually.
                    </div>
                </div>
                <div class="modal-footer app-modal-footer">
                    <button type="button" class="btn btn-light" data-bs-dismiss="modal">Cancel</button>
                    <button type="submit" class="btn btn-primary">
                        <i class="bi bi-check-circle me-2"></i>Create Monitoring
                    </button>
                </div>
            </form>
        </div>
    </div>
</div>

<!-- Edit Cost Savings Modal -->
<div class="modal fade" id="editCostSavingsModal" tabindex="-1" aria-labelledby="editCostSavingsModalLabel" aria-hidden="true">
    <div class="modal-dialog">
        <div class="modal-content">
            <div class="modal-header bg-primary text-white">
                <h5 class="modal-title" id="editCostSavingsModalLabel">
                    <i class="bi bi-pencil me-2"></i>Edit Cost Savings - <span id="editMonthName"></span>
                </h5>
                <button type="button" class="btn-close btn-close-white" data-bs-dismiss="modal" aria-label="Close"></button>
            </div>
            <form id="editCostSavingsForm">
                <div class="modal-body">
                    <input type="hidden" id="editMonitoringId" name="MonitoringId" />

                    <div class="mb-3">
                        <label for="editCostSavePlan" class="form-label">Cost Save Plan (USD)</label>
                        <input type="number" class="form-control" id="editCostSavePlan" name="CostSavePlan"
                               min="0" required />
                    </div>

                    <div class="mb-3">
                        <label for="editCostSaveActual" class="form-label">Cost Save Actual (USD)</label>
                        <input type="number" class="form-control" id="editCostSaveActual" name="CostSaveActual"
                               min="0" />
                        <small class="form-text text-muted">Leave empty if not available yet</small>
                    </div>
                </div>
                <div class="modal-footer">
                    <button type="button" class="btn btn-secondary" data-bs-dismiss="modal">Cancel</button>
                    <button type="submit" class="btn btn-primary">
                        <i class="bi bi-save me-2"></i>Save Changes
                    </button>
                </div>
            </form>
        </div>
    </div>
</div>

<!-- Validate Cost Savings Modal (SCFO only) -->
<div class="modal fade" id="validateCostSavingsModal" tabindex="-1" aria-labelledby="validateCostSavingsModalLabel" aria-hidden="true">
    <div class="modal-dialog">
        <div class="modal-content">
            <div class="modal-header bg-info text-white">
                <h5 class="modal-title" id="validateCostSavingsModalLabel">
                    <i class="bi bi-check-circle me-2"></i>Validate Cost Savings - <span id="validateMonthName"></span>
                </h5>
                <button type="button" class="btn-close btn-close-white" data-bs-dismiss="modal" aria-label="Close"></button>
            </div>
            <form id="validateCostSavingsForm">
                <div class="modal-body">
                    <input type="hidden" id="validateMonitoringId" name="MonitoringId" />

                    <div class="mb-3">
                        <label for="validateCostSaveActualValidated" class="form-label">Cost Save Actual Validated (USD)</label>
                        <input type="number" class="form-control" id="validateCostSaveActualValidated"
                               name="CostSaveActualValidated" min="0" required />
                        <small class="form-text text-muted">Enter the validated cost savings amount from Finance review</small>
                    </div>

                    <div class="alert alert-warning">
                        <i class="bi bi-exclamation-triangle me-2"></i>
                        This value represents the official validated cost savings by the Finance team.
                    </div>
                </div>
                <div class="modal-footer">
                    <button type="button" class="btn btn-secondary" data-bs-dismiss="modal">Cancel</button>
                    <button type="submit" class="btn btn-info">
                        <i class="bi bi-check-circle me-2"></i>Validate
                    </button>
                </div>
            </form>
        </div>
    </div>

    </div>
    <!-- End of inactive-section wrapper -->

</div>

@section Scripts {
<script>
$(document).ready(function() {
    let isEditing = false;

    // Edit Button
    $('#editBtn').on('click', function() {
        isEditing = true;
        $('.month-column').addClass('editing');
        $('#editBtn').hide();
        $('#saveBtn, #cancelBtn').show();
    });

    // Cancel Button
    $('#cancelBtn').on('click', function() {
        isEditing = false;

        // Reset all inputs to original values
        $('.value-input').each(function() {
            const original = $(this).data('original');
            $(this).val(original);
        });

        $('.month-column').removeClass('editing');
        $('#saveBtn, #cancelBtn').hide();
        $('#editBtn').show();
    });

    // Save Button
    $('#saveBtn').on('click', function() {
        const updates = [];
        let hasError = false;

        // Collect all input values - only if changed from original
        $('.value-input').each(function() {
            const input = $(this);
            const monitoringId = input.data('monitoring-id');
            const field = input.data('field');
            const originalValue = parseInt(input.data('original'));
            const currentValue = parseInt(input.val()) || 0;

            // Skip if value hasn't changed
            if (currentValue === originalValue) {
                return; // continue to next iteration
            }

            if (currentValue < 0) {
                hasError = true;
                Swal.fire({
                    icon: 'warning',
                    title: 'Invalid Value',
                    text: 'Values cannot be negative',
                    confirmButtonColor: '#f59e0b'
                });
                return false;
            }

            // Find or create update object for this monitoring ID
            let update = updates.find(u => u.monitoringId === monitoringId);
            if (!update) {
                update = { monitoringId: monitoringId };
                updates.push(update);
            }

            // Add field value
            if (field === 'plan') {
                update.costSavePlan = currentValue;
            } else if (field === 'actual') {
                update.costSaveActual = currentValue;
            } else if (field === 'validated') {
                update.costSaveActualValidated = currentValue;
            }
        });

        if (hasError) return;

        // Check if there are any changes to save
        if (updates.length === 0) {
            Swal.fire({
                icon: 'info',
                title: 'No Changes',
                text: 'No values have been modified.',
                confirmButtonColor: '#3b82f6'
            });
            return;
        }

        // Show loading alert
        Swal.fire({
            title: 'Saving Changes',
            text: 'Please wait...',
            allowOutsideClick: false,
            allowEscapeKey: false,
            didOpen: () => {
                Swal.showLoading();
            }
        });

        // Send all updates
        let completedRequests = 0;
        let allSuccess = true;

        updates.forEach(function(update) {
            // Update cost savings (plan + actual)
            if (update.costSavePlan !== undefined || update.costSaveActual !== undefined) {
                $.ajax({
                    url: '@Url.Action("UpdateCostSavings", "IdeaMonitoring")',
                    type: 'POST',
                    data: {
                        MonitoringId: update.monitoringId,
                        CostSavePlan: update.costSavePlan !== undefined ? update.costSavePlan : null,
                        CostSaveActual: update.costSaveActual !== undefined ? update.costSaveActual : null,
                        __RequestVerificationToken: $('input[name="__RequestVerificationToken"]').val()
                    },
                    success: function(response) {
                        if (!response.success) {
                            allSuccess = false;
                            console.error('Error updating cost savings:', response.message);
                        }
                    },
                    error: function() {
                        allSuccess = false;
                    },
                    complete: function() {
                        completedRequests++;
                        checkAllComplete();
                    }
                });
            }

            // Update validated (separate call)
            if (update.costSaveActualValidated !== undefined) {
                $.ajax({
                    url: '@Url.Action("UpdateCostSaveValidated", "IdeaMonitoring")',
                    type: 'POST',
                    data: {
                        MonitoringId: update.monitoringId,
                        CostSaveActualValidated: update.costSaveActualValidated,
                        __RequestVerificationToken: $('input[name="__RequestVerificationToken"]').val()
                    },
                    success: function(response) {
                        if (!response.success) {
                            allSuccess = false;
                            console.error('Error updating validated:', response.message);
                        }
                    },
                    error: function() {
                        allSuccess = false;
                    },
                    complete: function() {
                        completedRequests++;
                        checkAllComplete();
                    }
                });
            }
        });

        function checkAllComplete() {
            // Account for both cost savings and validated updates
            const expectedRequests = updates.reduce((sum, u) => {
                let count = 0;
                if (u.costSavePlan !== undefined || u.costSaveActual !== undefined) count++;
                if (u.costSaveActualValidated !== undefined) count++;
                return sum + count;
            }, 0);

            if (completedRequests >= expectedRequests) {
                if (allSuccess) {
                    Swal.fire({
                        icon: 'success',
                        title: 'Saved!',
                        text: 'All changes saved successfully!',
                        confirmButtonColor: '#3b82f6'
                    }).then(() => {
                        location.reload();
                    });
                } else {
                    Swal.fire({
                        icon: 'error',
                        title: 'Save Failed',
                        text: 'Some changes failed to save. Please check and try again.',
                        confirmButtonColor: '#ef4444'
                    });
                }
            }
        }
    });

    // Add KPI Form Submit
    $('#addKpiForm').on('submit', function(e) {
        e.preventDefault();

        const formData = new FormData(this);
        const data = Object.fromEntries(formData);

        $.ajax({
            url: '@Url.Action("AddKpi", "IdeaMonitoring")',
            type: 'POST',
            data: {
                ...data,
                __RequestVerificationToken: $('input[name="__RequestVerificationToken"]').val()
            },
            success: function(response) {
                if (response.success) {
                    $('#addKpiModal').modal('hide');
                    Swal.fire({
                        icon: 'success',
                        title: 'Success!',
                        text: response.message,
                        confirmButtonColor: '#3b82f6'
                    }).then(() => {
                        location.reload();
                    });
                } else {
                    Swal.fire({
                        icon: 'error',
                        title: 'Failed',
                        text: response.message,
                        confirmButtonColor: '#ef4444'
                    });
                }
            },
            error: function(xhr) {
                Swal.fire({
                    icon: 'error',
                    title: 'Error',
                    text: 'Error adding KPI. Please try again.',
                    confirmButtonColor: '#ef4444'
                });
            }
        });
    });

    // Extend Duration Form Submit
    $('#extendDurationForm').on('submit', function(e) {
        e.preventDefault();

        const formData = new FormData(this);
        const data = Object.fromEntries(formData);

        $.ajax({
            url: '@Url.Action("ExtendDuration", "IdeaMonitoring")',
            type: 'POST',
            data: {
                ...data,
                __RequestVerificationToken: $('input[name="__RequestVerificationToken"]').val()
            },
            success: function(response) {
                if (response.success) {
                    $('#extendDurationModal').modal('hide');
                    Swal.fire({
                        icon: 'success',
                        title: 'Success!',
                        text: 'Duration extended successfully!',
                        confirmButtonColor: '#3b82f6'
                    }).then(() => {
                        location.reload();
                    });
                } else {
                    Swal.fire({
                        icon: 'error',
                        title: 'Failed',
                        text: response.message,
                        confirmButtonColor: '#ef4444'
                    });
                }
            },
            error: function(xhr) {
                Swal.fire({
                    icon: 'error',
                    title: 'Error',
                    text: 'Error extending duration. Please try again.',
                    confirmButtonColor: '#ef4444'
                });
            }
        });
    });

    // Create Monitoring Form Submit
    $('#createMonitoringForm').on('submit', function(e) {
        e.preventDefault();

        const formData = new FormData(this);
        const data = Object.fromEntries(formData);

        // Convert month input to DateTime
        const monthFromInput = $('#monthFrom').val();
        data.MonthFrom = new Date(monthFromInput + '-01').toISOString();

        $.ajax({
            url: '@Url.Action("Create", "IdeaMonitoring")',
            type: 'POST',
            data: {
                ...data,
                __RequestVerificationToken: $('input[name="__RequestVerificationToken"]').val()
            },
            success: function(response) {
                if (response.success) {
                    $('#createMonitoringModal').modal('hide');
                    Swal.fire({
                        icon: 'success',
                        title: 'Success!',
                        text: 'Monitoring created successfully!',
                        confirmButtonColor: '#3b82f6'
                    }).then(() => {
                        location.reload();
                    });
                } else {
                    Swal.fire({
                        icon: 'error',
                        title: 'Failed',
                        text: response.message,
                        confirmButtonColor: '#ef4444'
                    });
                }
            },
            error: function(xhr) {
                Swal.fire({
                    icon: 'error',
                    title: 'Error',
                    text: 'Error creating monitoring. Please try again.',
                    confirmButtonColor: '#ef4444'
                });
            }
        });
    });

    // Edit Cost Savings Form Submit
    $('#editCostSavingsForm').on('submit', function(e) {
        e.preventDefault();

        const formData = new FormData(this);
        const data = Object.fromEntries(formData);

        $.ajax({
            url: '@Url.Action("UpdateCostSavings", "IdeaMonitoring")',
            type: 'POST',
            data: {
                ...data,
                __RequestVerificationToken: $('input[name="__RequestVerificationToken"]').val()
            },
            success: function(response) {
                if (response.success) {
                    $('#editCostSavingsModal').modal('hide');
                    Swal.fire({
                        icon: 'success',
                        title: 'Success!',
                        text: 'Cost savings updated successfully!',
                        confirmButtonColor: '#3b82f6'
                    }).then(() => {
                        location.reload();
                    });
                } else {
                    Swal.fire({
                        icon: 'error',
                        title: 'Failed',
                        text: response.message,
                        confirmButtonColor: '#ef4444'
                    });
                }
            },
            error: function(xhr) {
                Swal.fire({
                    icon: 'error',
                    title: 'Error',
                    text: 'Error updating cost savings. Please try again.',
                    confirmButtonColor: '#ef4444'
                });
            }
        });
    });

    // Validate Cost Savings Form Submit
    $('#validateCostSavingsForm').on('submit', function(e) {
        e.preventDefault();

        const formData = new FormData(this);
        const data = Object.fromEntries(formData);

        $.ajax({
            url: '@Url.Action("UpdateCostSaveValidated", "IdeaMonitoring")',
            type: 'POST',
            data: {
                ...data,
                __RequestVerificationToken: $('input[name="__RequestVerificationToken"]').val()
            },
            success: function(response) {
                if (response.success) {
                    $('#validateCostSavingsModal').modal('hide');
                    Swal.fire({
                        icon: 'success',
                        title: 'Success!',
                        text: 'Cost savings validated successfully!',
                        confirmButtonColor: '#3b82f6'
                    }).then(() => {
                        location.reload();
                    });
                } else {
                    Swal.fire({
                        icon: 'error',
                        title: 'Failed',
                        text: response.message,
                        confirmButtonColor: '#ef4444'
                    });
                }
            },
            error: function(xhr) {
                Swal.fire({
                    icon: 'error',
                    title: 'Error',
                    text: 'Error validating cost savings. Please try again.',
                    confirmButtonColor: '#ef4444'
                });
            }
        });
    });
});

// Open Edit Modal
function openEditModal(monitoringId, costSavePlan, costSaveActual, monthName) {
    $('#editMonitoringId').val(monitoringId);
    $('#editCostSavePlan').val(costSavePlan);
    $('#editCostSaveActual').val(costSaveActual > 0 ? costSaveActual : '');
    $('#editMonthName').text(monthName);
    $('#editCostSavingsModal').modal('show');
}

// Open Validate Modal
function openValidateModal(monitoringId, costSaveActualValidated, monthName) {
    $('#validateMonitoringId').val(monitoringId);
    $('#validateCostSaveActualValidated').val(costSaveActualValidated > 0 ? costSaveActualValidated : '');
    $('#validateMonthName').text(monthName);
    $('#validateCostSavingsModal').modal('show');
}

// ============================================================================
// FILE UPLOAD HANDLER (from Create.cshtml)
// ============================================================================

const FILE_CONFIG = {
    allowedExtensions: ['.pdf', '.doc', '.docx', '.xls', '.xlsx', '.ppt', '.pptx', '.jpg', '.jpeg', '.png'],
    maxSizePerFile: 10 * 1024 * 1024, // 10MB
    maxTotalSize: 10 * 1024 * 1024    // 10MB
};

let selectedAttachmentFiles = [];
let attachmentFileCounter = 0;

function validateFile(file) {
    const fileName = file.name.toLowerCase();
    const fileExt = fileName.substring(fileName.lastIndexOf('.'));

    if (!FILE_CONFIG.allowedExtensions.includes(fileExt)) {
        return `File type '${fileExt}' is not allowed. Allowed types: ${FILE_CONFIG.allowedExtensions.join(', ')}`;
    }

    if (file.size > FILE_CONFIG.maxSizePerFile) {
        const fileSizeMB = (file.size / (1024 * 1024)).toFixed(2);
        return `File '${file.name}' (${fileSizeMB} MB) exceeds the maximum size of 10 MB per file`;
    }

    return null;
}

$('#attachmentFileInput').change(function() {
    const files = Array.from(this.files);
    if (!files.length) return;

    const currentTotalSize = selectedAttachmentFiles.reduce((sum, f) => sum + f.size, 0);
    let newFilesSize = 0;
    const validFiles = [];
    let errorMessage = '';

    for (const file of files) {
        errorMessage = validateFile(file);
        if (errorMessage) break;

        newFilesSize += file.size;
        validFiles.push(file);
    }

    const totalSizeAfterAdd = currentTotalSize + newFilesSize;
    if (!errorMessage && totalSizeAfterAdd > FILE_CONFIG.maxTotalSize) {
        const totalSizeMB = (totalSizeAfterAdd / (1024 * 1024)).toFixed(2);
        const maxTotalMB = (FILE_CONFIG.maxTotalSize / (1024 * 1024)).toFixed(0);
        errorMessage = `Total file size (${totalSizeMB} MB) would exceed the maximum allowed total size of ${maxTotalMB} MB`;
    }

    if (errorMessage) {
        Swal.fire({
            icon: 'warning',
            title: 'File Validation Failed',
            text: errorMessage,
            confirmButtonText: 'OK'
        });
        this.value = '';
        return;
    }

    validFiles.forEach(file => {
        const fileObj = {
            id: attachmentFileCounter++,
            file: file,
            name: file.name,
            size: file.size,
            type: file.type
        };

        selectedAttachmentFiles.push(fileObj);
        addAttachmentFileToList(fileObj);
        createHiddenAttachmentInput(fileObj);
    });

    updateAttachmentFilesDisplay();
    this.value = '';
});

function addAttachmentFileToList(fileObj) {
    const fileSize = formatFileSize(fileObj.size);
    const fileIcon = getFileIcon(fileObj.name);

    const fileItem = `
        <div class="d-flex align-items-center justify-content-between p-2 border rounded mb-2 bg-white" id="attachmentFile-${fileObj.id}">
            <div class="d-flex align-items-center">
                <i class="bi ${fileIcon} fs-4 me-3 text-primary"></i>
                <div>
                    <div class="fw-medium">${fileObj.name}</div>
                    <small class="text-muted">${fileSize}</small>
                </div>
            </div>
            <button type="button" class="btn btn-outline-danger btn-sm" onclick="removeAttachmentFile(${fileObj.id})">
                <i class="bi bi-trash"></i>
            </button>
        </div>
    `;

    $('#attachmentFilesList').append(fileItem);
}

function removeAttachmentFile(fileId) {
    selectedAttachmentFiles = selectedAttachmentFiles.filter(f => f.id !== fileId);
    $(`#attachmentFile-${fileId}`).remove();
    $(`#hiddenAttachmentFile-${fileId}`).remove();
    updateAttachmentFilesDisplay();
}

function createHiddenAttachmentInput(fileObj) {
    const input = $(`<input type="file" name="AttachmentFiles" id="hiddenAttachmentFile-${fileObj.id}" style="display:none" />`);
    const dataTransfer = new DataTransfer();
    dataTransfer.items.add(fileObj.file);
    input[0].files = dataTransfer.files;
    $('#hiddenAttachmentFileInputs').append(input);
}

function updateAttachmentFilesDisplay() {
    const noFilesMsg = $('#noAttachmentFilesMessage');
    if (selectedAttachmentFiles.length === 0) {
        noFilesMsg.show();
    } else {
        noFilesMsg.hide();
    }
}

function formatFileSize(bytes) {
    if (bytes === 0) return '0 Bytes';
    const k = 1024;
    const sizes = ['Bytes', 'KB', 'MB', 'GB'];
    const i = Math.floor(Math.log(bytes) / Math.log(k));
    return parseFloat((bytes / Math.pow(k, i)).toFixed(2)) + ' ' + sizes[i];
}

function getFileIcon(filename) {
    const ext = filename.toLowerCase().split('.').pop();
    const icons = {
        'pdf': 'bi-file-earmark-pdf',
        'doc': 'bi-file-earmark-word',
        'docx': 'bi-file-earmark-word',
        'xls': 'bi-file-earmark-excel',
        'xlsx': 'bi-file-earmark-excel',
        'ppt': 'bi-file-earmark-ppt',
        'pptx': 'bi-file-earmark-ppt',
        'jpg': 'bi-file-earmark-image',
        'jpeg': 'bi-file-earmark-image',
        'png': 'bi-file-earmark-image',
        'gif': 'bi-file-earmark-image'
    };
    return icons[ext] || 'bi-file-earmark';
}

window.removeAttachmentFile = removeAttachmentFile;

// Form Submit
$('#uploadAttachmentForm').submit(function(e) {
    e.preventDefault();

    if (selectedAttachmentFiles.length === 0) {
        Swal.fire({
            icon: 'warning',
            title: 'No Files Selected',
            text: 'Please select at least one file to upload.',
            confirmButtonText: 'OK'
        });
        return;
    }

    const submitBtn = $('#uploadAttachmentBtn');
    submitBtn.prop('disabled', true).html('<span class="spinner-border spinner-border-sm me-2"></span>Uploading...');

    const formData = new FormData(this);
    formData.append('__RequestVerificationToken', $('input[name="__RequestVerificationToken"]').val());

    $.ajax({
        url: '@Url.Action("UploadAttachments", "IdeaMonitoring")',
        type: 'POST',
        data: formData,
        processData: false,
        contentType: false,
        success: function(response) {
            if (response.success) {
                Swal.fire({
                    icon: 'success',
                    title: 'Success!',
                    text: response.message || 'Files uploaded successfully',
                    confirmButtonText: 'OK'
                }).then(function() {
                    location.reload();
                });
            } else {
                Swal.fire({
                    icon: 'error',
                    title: 'Upload Failed',
                    text: response.message || 'Failed to upload files',
                    confirmButtonText: 'Try Again'
                });
                submitBtn.prop('disabled', false).html('<i class="bi bi-upload me-2"></i>Upload Files');
            }
        },
        error: function(xhr) {
            let errorMessage = 'An unexpected error occurred';
            if (xhr.responseJSON && xhr.responseJSON.message) {
                errorMessage = xhr.responseJSON.message;
            }

            Swal.fire({
                icon: 'error',
                title: 'Error!',
                text: errorMessage,
                confirmButtonText: 'Try Again'
            });
            submitBtn.prop('disabled', false).html('<i class="bi bi-upload me-2"></i>Upload Files');
        }
    });
});
</script>
}
